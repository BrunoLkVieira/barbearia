{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcionamento - {{ barbershop.name }}</title>
    <link rel="shortcut icon" href="{% static 'geral/img/logo.ico' %}" type="image/x-icon">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'barbershop/css/desktop/workDay.css' %}">
    <link rel="stylesheet" href="{% static 'barbershop/css/mobile/workDay.css' %}">

    <link rel="stylesheet" href="{% static 'barbershop/css/desktop/modals/abscense.css' %}">
    <link rel="stylesheet" href="{% static 'barbershop/css/mobile/modals/abscense.css' %}">
    
    <link rel="stylesheet" href="{% static 'barbershop/css/desktop/modals/editCalendar.css' %}">
    <link rel="stylesheet" href="{% static 'barbershop/css/mobile/modals/editCalendar.css' %}">
    
    <link rel="stylesheet" href="{% static 'barbershop/css/desktop/modals/createHoliday.css' %}">
    
    <link rel="stylesheet" href="{% static 'geral/css/desktop/style.css' %}">
    <link rel="stylesheet" href="{% static 'geral/css/mobile/style.css' %}">

</head>

<body>
    {% include "geral/header.html" %}
    
    <div class="nav-bar">
        {% include "geral/nav.html" %}
        <div class="nav-content">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value">{{ employees.count }}</div>
                    <div class="stat-label">Funcionarios</div>
                </div>
            </div>
        </div>
    </div>

    <div class="pages-options-Container">

        {% if request.user.user_type == "dono" %}
            <a href="{% url 'barbershop:units' barbershop_slug=barbershop.slug %}">
                <div class="page-option "><i class="fas fa-store"></i> Unidades</div>
            </a>
        {% endif %}


        {% if request.user.user_type != "funcionario" %}    
            {% if request.user.user_type == "dono" %}
                <a href="{% url 'barbershop:employee_general' barbershop_slug=barbershop.slug %}">
                    <div class="page-option "><i class="fas fa-users"></i> Funcionarios</div>
                </a>
            
            {% elif request.user.user_type == "gerente" %}
                <a href="{% url 'barbershop:employee_unit' barbershop_slug=barbershop.slug unit_slug=gerente_unit.slug %}">
                    <div class="page-option "><i class="fas fa-users"></i> Funcionarios</div>
                </a>
            {% endif %}
        {% endif %}
    
        <a href="">
            <div class="page-option active"><i class="fas fa-clock"></i> Funcionamento</div>
        </a>
    </div>

    <div class="main-content">
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-user-clock"></i> Disponibilidade de Barbeiros
                </div>
            </div>
            
            <div class="barbers-list">
                {% for barber in employees %}
                <div class="barber-card">
                    <div class="barber-info">
                        <div class="barber-avatar">{{ barber.user.name|slice:":1"|upper }}{{ barber.user.last_name|slice:":1"|upper }}</div>
                        <div>
                            <div class="barber-name">{{ barber.user.name }} {{ barber.user.last_name }}</div>
                        </div>
                    </div>
                    <div class="available-days">
                        {% for wd in workdays.all %}
                            {% if wd.employee == barber %}
                                <div class="day-badge {% if not wd.morning_available and not wd.afternoon_available %}off{% endif %}">
                                    {{ wd.get_weekday_display|slice:":3"|upper }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <button class="edit-btn" onclick="openEditModal({{ barber.id }})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calendar-times"></i> Dias de Não Funcionamento
                </div>
                <button class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#createHolidayModal" onclick="openHolidayModal()">
                    <i class="fas fa-plus"></i> Adicionar Dia
                </button>
            </div>
            
            <div class="non-working-days">
                {% for holiday in holidays %}
                <div class="day-off-card">
                    <div class="day-off-actions">
                        <button class="day-off-btn" 
                                onclick="editHolidayModal('{{ holiday.id }}', '{{ holiday.name }}', '{{ holiday.date|date:"Y-m-d" }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form method="POST" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir este dia?')">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_holiday">
                            <input type="hidden" name="holiday_id" value="{{ holiday.id }}">
                            <button type="submit" class="day-off-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    <div class="day-off-date">{{ holiday.date|date:"d/m/Y" }}</div>
                    <div class="day-off-reason">{{ holiday.name }} ({{holiday.unit.name}})</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-umbrella-beach"></i> Folgas Agendadas
                </div>

                <button class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#createAbsenceModal" onclick="openVacationModal()">
                    <i class="fas fa-plus"></i> Marcar Folga
                </button>
            </div>
            
            <div class="non-working-days">
                 {% for absence in absences %}
                    <div class="day-off-card blue-card">
                         <div class="day-off-actions">
                             <form method="POST" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta folga?')">
                                 {% csrf_token %}
                                 <input type="hidden" name="action" value="delete_absence">
                                 <input type="hidden" name="absence_id" value="{{ absence.id }}">
                                 <button type="submit" class="day-off-btn">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             </form>
                         </div>
                         <div class="day-off-date">
                            {{ absence.start_date|date:"d/m/Y" }}
                            {% if absence.end_date and absence.end_date != absence.start_date %}
                                <span>até</span>
                                <div class="end-absence-day">{{ absence.end_date|date:"d/m/Y" }}</div>
                            {% endif %}
                         </div>
                         <div class="day-off-reason">{{ absence.employee.user.name }}: {{ absence.reason }}</div>
                    </div>
                 {% endfor %}
            </div>
        </div>
    </div>
    
    <footer>
        <div class="total-display">
            <div class="footer-first-row-one-item">
                Próximo dia de folga: <strong>{{ holidays.first.date|date:"d \d\e F, Y"|default:"Nenhum agendado" }}</strong>
            </div>
        </div>
    </footer>
    

    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2><i class="fas fa-user-clock"></i> Editar Disponibilidade</h2>
                <button class="close-btn" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
    
            <div class="edit-modal-body">
                <div class="barber-selector">
                    <div class="barber-selector-item active">
                        <div>Manhã</div>
                    </div>
                    <div class="barber-selector-item">
                        <div>Tarde</div>
                    </div>
                </div>
                
                <div class="days-grid">
                    <form method="POST" action="" class="edit-calendar-form" id="editWorkdayForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="edit_workday">
                        <input type="hidden" name="employee_id" id="formEmployeeId">
    
                        {% comment %} Bloco para o período da MANHÃ {% endcomment %}
                        {% for i in "0123456"|make_list %}
                            {% with weekday_index=i|add:0 %}
                                <div class="day-edit off morning" data-weekday="{{ weekday_index }}" data-period="morning">
                                    <div class="left-area-day">
                                        <div class="day-abbreviation">
                                            {% if weekday_index == 0 %}DOM{% elif weekday_index == 1 %}SEG{% elif weekday_index == 2 %}TER{% elif weekday_index == 3 %}QUA{% elif weekday_index == 4 %}QUI{% elif weekday_index == 5 %}SEX{% else %}SAB{% endif %}
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" onchange="handleToggleClick(this)" name="is_available_{{ weekday_index }}_morning">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="time-input-group">
                                        <select class="time-input" name="start_morning_work_{{ weekday_index }}">
                                            {% for time in time_options %}
                                                <option value="{{ time }}">{{ time }}</option>
                                            {% endfor %}
                                        </select>
                                        <span class="time-divider">-</span>
                                        <select class="time-input" name="end_morning_work_{{ weekday_index }}">
                                            {% for time in time_options %}
                                                <option value="{{ time }}">{{ time }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            {% endwith %}
                        {% endfor %}
    
                        {% comment %} Bloco para o período da TARDE {% endcomment %}
                        {% for i in "0123456"|make_list %}
                            {% with weekday_index=i|add:0 %}
                                <div class="day-edit off afternoon" data-weekday="{{ weekday_index }}" data-period="afternoon">
                                    <div class="left-area-day">
                                        <div class="day-abbreviation">
                                            {% if weekday_index == 0 %}DOM{% elif weekday_index == 1 %}SEG{% elif weekday_index == 2 %}TER{% elif weekday_index == 3 %}QUA{% elif weekday_index == 4 %}QUI{% elif weekday_index == 5 %}SEX{% else %}SAB{% endif %}
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" onchange="handleToggleClick(this)" name="is_available_{{ weekday_index }}_afternoon">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="time-input-group">
                                        <select class="time-input" name="start_afternoon_work_{{ weekday_index }}">
                                            {% for time in time_options %}
                                                <option value="{{ time }}">{{ time }}</option>
                                            {% endfor %}
                                        </select>
                                        <span class="time-divider">-</span>
                                        <select class="time-input" name="end_afternoon_work_{{ weekday_index }}">
                                            {% for time in time_options %}
                                                <option value="{{ time }}">{{ time }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            {% endwith %}
                        {% endfor %}
    
                    </form>
                </div>
            </div>
            
            <div class="edit-modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">Cancelar</button>
                <button class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="createHolidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-times"></i> Adicionar Dia de Não Funcionamento</h2>
                <button class="close-btn" onclick="closeHolidayModal()"><i class="fas fa-times"></i></button>
            </div>
            <form method="POST" class="holiday-form">
                {%csrf_token%}
                <input type="hidden" name="action" value="create_holiday">
                <div class="holiday-modal-body">
                    <div class="holiday-modal-section">
                        <h3 class="modal-title"><i class="fas fa-tag"></i> Nome do Dia Especial</h3>
                        <input type="text" name="name" id="holidayName" placeholder="Ex: Feriado Nacional, Reforma, etc." class="holiday-input" required>
                    </div>
                    
                    <div class="holiday-modal-section">
                        <h3 class="modal-title"><i class="fas fa-store"></i> Unidade</h3>
                        <select name="unit_id" class="holiday-input" required>
                            <option value="" disabled selected>Selecione a unidade</option>
                            {% for unit in units %}
                            <option value="{{ unit.id }}">{{ unit.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="holiday-modal-section">
                        <h3 class="modal-title"><i class="fas fa-calendar-day"></i> Data</h3>
                        <input type="date" name="date" class="holiday-input" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeHolidayModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Dia</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editHolidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-times"></i> Editar Dia de Não Funcionamento</h2>
                <button class="close-btn" onclick="closeEditHolidayModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="holiday-modal-body">
                <form id="editHolidayForm" class="holiday-form">
                    {%csrf_token%}
                    <div class="holiday-modal-section">
                        <h3 class="modal-title"><i class="fas fa-tag"></i> Nome do Dia Especial</h3>
                        <input type="text" name="name" class="holiday-input" required>
                    </div>
                    
                    <div class="holiday-modal-section">
                        <h3 class="modal-title"><i class="fas fa-calendar-day"></i> Data</h3>
                        <input type="date" name="date" class="holiday-input" required>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeEditHolidayModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Dia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-umbrella-beach"></i> Marcar Folga</h2>
                <button class="close-btn" onclick="closeVacationModal()"><i class="fas fa-times"></i></button>
            </div>

            <form method="POST" class="absence-form">
                {%csrf_token%}
                <input type="hidden" name="action" value="create_absence">
                <div class="modal-body">
                    <div class="modal-section">
                        <h3 class="modal-title"><i class="fas fa-users"></i> Selecione o(s) Barbeiro(s)</h3>
                        <div class="barber-list" id="vacationBarbersList">
                             {% for employee in employees %}
                            <label class="barber-item">
                                <input type="checkbox" name="employee_id" value="{{ employee.id }}">
                                <div class="barber-avatar">{{ employee.user.name|slice:":1"|upper }}{{ employee.user.last_name|slice:":1"|upper }}</div>
                                <div class="modal-barber-name">{{ employee.user.name }} {{ employee.user.last_name }}</div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="modal-section">
                        <h3 class="modal-title"><i class="fas fa-comment-alt"></i> Motivo</h3>
                        <input type="text" name="reason" class="holiday-input" placeholder="Ex: Férias, consulta, etc." required>
                    </div>
                    
                    <div class="modal-section">
                        <h3 class="modal-title"><i class="fas fa-calendar-alt"></i> Período de Folga</h3>
                        <div class="date-inputs">
                            <div class="date-group">
                                <label>Data de Início</label>
                                <input type="date" name="date_start" id="vacationStart">
                            </div>
                            <div class="date-group">
                                <label>Data de Término</label>
                                <input type="date" name="date_end" id="vacationEnd">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeVacationModal()" type="button">Cancelar</button>
                    <button class="btn btn-primary" type="submit">Confirmar Folga</button>
                </div>
            </form>
        </div>
    </div>
    
    {{ workdays_json|json_script:"workdays-data" }}

    <script src="{% static 'geral/js/script.js' %}"></script>
    <script src="{% static 'barbershop/js/workDay.js' %}"></script>
    <script>
        const workdaysData = {{ workdays_json|safe }};
    </script>
</body>
</html>